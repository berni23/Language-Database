<html>
<head>
<title>Statistics4Fragment.kt</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #000080; font-weight: bold;}
.s1 { color: #000000;}
.s2 { color: #0000ff;}
.s3 { color: #008000; font-weight: bold;}
.s4 { color: #808080; font-style: italic;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Statistics4Fragment.kt</font>
</center></td></tr></table>
<pre><span class="s0">package </span>com.berni.android.prototype1lanbase.ui.statistics


import android.os.Bundle
import android.util.Log
import android.view.*
import androidx.lifecycle.ViewModelProvider
import androidx.navigation.NavController
import androidx.navigation.Navigation
import com.anychart.APIlib
import com.anychart.AnyChart
import com.anychart.chart.common.dataentry.DataEntry
import com.anychart.chart.common.dataentry.ValueDataEntry
import com.berni.android.prototype1lanbase.R
import com.berni.android.prototype1lanbase.ui.BaseFragment
import com.berni.android.prototype1lanbase.ui.viewmodel.MainViewModel
import com.berni.android.prototype1lanbase.ui.viewmodel.ViewModelFactory
import com.jakewharton.threetenabp.AndroidThreeTen
import kotlinx.android.synthetic.main.fragment_statistics4.*
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.runBlocking
import org.kodein.di.KodeinAware
import org.kodein.di.android.x.closestKodein
import org.kodein.di.generic.instance
import org.threeten.bp.LocalDate
import org.threeten.bp.format.DateTimeFormatter
import org.threeten.bp.temporal.ChronoUnit
import kotlin.collections.ArrayList
import kotlin.math.abs


<span class="s0">class </span>Statistics4Fragment : BaseFragment(),KodeinAware {

    override <span class="s0">val </span>kodein by closestKodein()
    private <span class="s0">val </span>viewModelFactory: ViewModelFactory by instance&lt;ViewModelFactory&gt;()
    private lateinit <span class="s0">var </span>viewModel: MainViewModel
    private lateinit <span class="s0">var </span>navController: NavController

    override <span class="s0">fun </span>onCreateView(

        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {

        setHasOptionsMenu(<span class="s0">true</span>)
        <span class="s0">return </span>inflater.inflate(R.layout.fragment_statistics4, container, <span class="s0">false</span>)
    }

    override <span class="s0">fun </span>onViewCreated(view: View, savedInstanceState: Bundle?) {

        navController = Navigation.findNavController(view)
        viewModel = ViewModelProvider(<span class="s0">this</span>, viewModelFactory).get(MainViewModel::<span class="s0">class</span>.java)

        <span class="s0">var </span>date = mutableListOf&lt;String&gt;()
        <span class="s0">var </span>dateAcquired = mutableListOf&lt;String&gt;()

        runBlocking(Dispatchers.Default) {
            date = viewModel.orderDays()
            dateAcquired = viewModel.orderAcquired()
        }

        APIlib.getInstance().setActiveAnyChartView(lineChart3)
        <span class="s0">val </span>lineMonths = AnyChart.line()
        <span class="s0">val </span>dataMonths = arrayMonths(sortMonths(date))
        lineMonths.data(dataMonths)
        lineChart3.setChart(lineMonths)

        <span class="s0">if</span>(dateAcquired.isNotEmpty())

        {
            NoChartAcquired.visibility = View.INVISIBLE
            APIlib.getInstance().setActiveAnyChartView(lineChart4)
            <span class="s0">val </span>lineMonths2 = AnyChart.line()
            <span class="s0">val </span>dataMonths2 = arrayMonths(sortMonths(dateAcquired))
            lineMonths2.data(dataMonths2)
            lineChart4.setChart(lineMonths2)
        }

        changeGraphs2.setOnClickListener {navController.popBackStack()}
        <span class="s0">super</span>.onViewCreated(view, savedInstanceState)
    }

    private <span class="s0">fun </span>sortMonths(date: MutableList&lt;String&gt;): ArrayList&lt;String&gt; {

        <span class="s0">val </span>months = arrayListOf&lt;String&gt;()
        date.forEach {months.add(it.substring(<span class="s2">3</span>,it.lastIndex + <span class="s2">1</span>)) }
        months.sort()
        months.sortBy {it.substring(<span class="s2">3</span>,<span class="s2">7</span>).toInt() }
        <span class="s0">return </span>months

    }

    private <span class="s0">fun </span>arrayMonths(months: ArrayList&lt;String&gt;): ArrayList&lt;DataEntry&gt; {

        AndroidThreeTen.init(activity)
        <span class="s0">var </span>xAxis = mutableListOf&lt;String&gt;()
        <span class="s0">val </span>format1 = DateTimeFormatter.ofPattern(<span class="s3">&quot;MM/yyyy&quot;</span>)
        <span class="s0">val </span>format2 = DateTimeFormatter.ofPattern(<span class="s3">&quot;dd/MM/yyyy&quot;</span>)
        <span class="s0">val </span>today = LocalDate.now()
        <span class="s4">//.plusMonths(7) ( code useful for debugging)</span>
        <span class="s0">val </span>firstMonth = LocalDate.parse(<span class="s3">&quot;01/</span><span class="s0">${</span>months[<span class="s2">0</span>]<span class="s0">}</span><span class="s3">&quot;</span>, format2)
        <span class="s0">val </span>dataMonth = ArrayList&lt;DataEntry&gt;()

        <span class="s0">var </span>monthsPassed = abs(today.until(firstMonth, ChronoUnit.MONTHS))
        Log.println(Log.INFO, <span class="s3">&quot;monthsPassed&quot;</span>, monthsPassed.toString())
        <span class="s0">if </span>(monthsPassed &gt; <span class="s2">6</span>) { monthsPassed = <span class="s2">6 </span>}

        <span class="s0">if </span>(monthsPassed.toInt() == <span class="s2">0</span>) {
            xAxis.add(format1.format(today))
            dataMonth.add(ValueDataEntry(xAxis[<span class="s2">0</span>], months.count {it == xAxis[<span class="s2">0</span>]}))


        } <span class="s0">else </span>{

            <span class="s0">for </span>(i <span class="s0">in </span><span class="s2">0</span>..monthsPassed) { xAxis.add(format1.format(today.minusMonths(i))) }

            xAxis = xAxis.asReversed()
            <span class="s0">val </span>range = xAxis.size -<span class="s2">1</span>

            <span class="s0">for </span>(i <span class="s0">in </span><span class="s2">0</span>..range) { dataMonth.add(ValueDataEntry(xAxis[i], months.count {it == xAxis[i]})) }

        }
        <span class="s0">return </span>dataMonth
    }

}


    <span class="s4">/**    private fun dataMonths(months: List&lt;String&gt;): ArrayList&lt;DataEntry&gt; {</span>

            <span class="s4">val dataMonths = ArrayList&lt;DataEntry&gt;()</span>
            <span class="s4">var counterMonths = months.groupingBy {it}.eachCount().toList()</span>
            <span class="s4">if (counterMonths.size &gt; 6) {counterMonths = counterMonths.takeLast(6) }</span>
            <span class="s4">counterMonths.toMap()</span>
            <span class="s4">counterMonths.forEach {dataMonths.add(ValueDataEntry(it.first, it.second)) }</span>
            <span class="s4">return dataMonths</span>

        <span class="s4">}</span>

    <span class="s4">**</span>

    <span class="s4">override fun onAttach(context: Context) {</span>
        <span class="s4">super.onAttach(context)</span>
        <span class="s4">val callback: OnBackPressedCallback = object : OnBackPressedCallback(</span>
            <span class="s4">true</span>
        <span class="s4">) {</span>
            <span class="s4">override fun handleOnBackPressed() {</span>
                <span class="s4">navController.navigate(R.id.actionBackToMainS4)</span>
            <span class="s4">}</span>
        <span class="s4">}</span>
        <span class="s4">requireActivity().onBackPressedDispatcher.addCallback(</span>
            <span class="s4">this,  // LifecycleOwner</span>
            <span class="s4">callback</span>
        <span class="s4">)</span>
    <span class="s4">}</span>

    <span class="s4">override fun onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {</span>
        <span class="s4">inflater.inflate(R.menu.menu_s3, menu)</span>
        <span class="s4">return super.onCreateOptionsMenu(menu, inflater)</span>
    <span class="s4">}</span>

    <span class="s4">override fun onOptionsItemSelected(item: MenuItem): Boolean {</span>

        <span class="s4">when (item.itemId) {R.id.item_backS3 -&gt; {navController.navigate(R.id.action_BackToS1)} }</span>

        <span class="s4">return super.onOptionsItemSelected(item)</span>
    <span class="s4">}</span>
<span class="s4">}**/</span>



</pre>
</body>
</html>