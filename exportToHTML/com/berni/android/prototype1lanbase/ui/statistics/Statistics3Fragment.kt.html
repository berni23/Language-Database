<html>
<head>
<title>Statistics3Fragment.kt</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #000080; font-weight: bold;}
.s1 { color: #000000;}
.s2 { color: #808080; font-style: italic;}
.s3 { color: #0000ff;}
.s4 { color: #008000; font-weight: bold;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Statistics3Fragment.kt</font>
</center></td></tr></table>
<pre><span class="s0">package </span>com.berni.android.prototype1lanbase.ui.statistics


import android.content.Context
import android.os.Bundle
import android.util.Log
import android.view.*
import androidx.activity.OnBackPressedCallback
import kotlinx.android.synthetic.main.fragment_statistics3.*
import androidx.lifecycle.ViewModelProvider
import androidx.navigation.NavController
import androidx.navigation.Navigation
import com.anychart.APIlib
import com.anychart.AnyChart
import com.anychart.chart.common.dataentry.DataEntry
import com.anychart.chart.common.dataentry.ValueDataEntry
import com.berni.android.prototype1lanbase.R
import com.berni.android.prototype1lanbase.ui.BaseFragment
import com.berni.android.prototype1lanbase.ui.viewmodel.MainViewModel
import com.berni.android.prototype1lanbase.ui.viewmodel.ViewModelFactory
import com.jakewharton.threetenabp.AndroidThreeTen
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.runBlocking
import org.kodein.di.KodeinAware
import org.kodein.di.android.x.closestKodein
import org.kodein.di.generic.instance
import org.threeten.bp.LocalDate
import org.threeten.bp.format.DateTimeFormatter
import org.threeten.bp.temporal.ChronoUnit
import java.lang.Math.abs
import kotlin.collections.ArrayList

<span class="s0">class </span>Statistics3Fragment : BaseFragment(),KodeinAware {

    override <span class="s0">val </span>kodein by closestKodein()
    private <span class="s0">val </span>viewModelFactory: ViewModelFactory by instance&lt;ViewModelFactory&gt;()
    private lateinit <span class="s0">var </span>navController: NavController
    private lateinit <span class="s0">var </span>viewModel: MainViewModel

    override <span class="s0">fun </span>onCreateView(

        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {

        setHasOptionsMenu(<span class="s0">true</span>)
        <span class="s0">return </span>inflater.inflate(R.layout.fragment_statistics3, container, <span class="s0">false</span>)
    }

    override <span class="s0">fun </span>onViewCreated(view: View, savedInstanceState: Bundle?) {

        navController = Navigation.findNavController(view)
        viewModel = ViewModelProvider(<span class="s0">this</span>, viewModelFactory).get(MainViewModel::<span class="s0">class</span>.java)

        <span class="s0">var </span>days = ArrayList&lt;String&gt;()
        <span class="s0">var </span>daysAcquired = ArrayList&lt;String&gt;()

        runBlocking(Dispatchers.Default) {

            daysAcquired =viewModel.orderAcquired() <span class="s0">as </span>ArrayList&lt;String&gt;
            days = viewModel.orderDays() <span class="s0">as </span>ArrayList&lt;String&gt;

        }

        <span class="s2">//Log.println(Log.INFO,&quot;acquired&quot;,daysAcquired.toString())</span>
        APIlib.getInstance().setActiveAnyChartView(lineChart)
        <span class="s0">val </span>lineDays = AnyChart.line()
        <span class="s0">val </span>dataDays = arrayDays(sortDays(days))

        lineDays.line(dataDays)
        lineChart.setChart(lineDays)

        <span class="s0">if </span>(daysAcquired.isNotEmpty()) {

            NoChartAcquired.visibility = View.INVISIBLE
            <span class="s2">//labelsG1.visibility = View.VISIBLE</span>
            APIlib.getInstance().setActiveAnyChartView(lineChart2)
            <span class="s0">val </span>lineDays2 = AnyChart.line()
            <span class="s0">val </span>dataDays2 = arrayDays(sortDays(daysAcquired))
            lineDays2.data(dataDays2)
            lineChart2.setChart(lineDays2)
        }
        <span class="s2">//lineChart.setChart(lineDays2)</span>
        changeGraphs.setOnClickListener {navController.navigate(R.id.actionMonthlyView)}
        <span class="s0">super</span>.onViewCreated(view, savedInstanceState)

    }

    private <span class="s0">fun </span>sortDays(days: ArrayList&lt;String&gt;): ArrayList&lt;String&gt; {

        days.sort()
        days.sortBy {it.substring(<span class="s3">3</span>, <span class="s3">5</span>).toInt()}
        days.sortBy {it.substring(<span class="s3">6</span>, <span class="s3">10</span>).toInt()}

        Log.println(Log.INFO,<span class="s4">&quot;days&quot;</span>,days.toString())
        <span class="s0">return </span>days
    }

    override <span class="s0">fun </span>onAttach(context: Context) {
        <span class="s0">super</span>.onAttach(context)
        <span class="s0">val </span>callback: OnBackPressedCallback = <span class="s0">object </span>: OnBackPressedCallback(
            <span class="s0">true</span>
        ) {
            override <span class="s0">fun </span>handleOnBackPressed() {
                navController.navigate(R.id.actionBackToMainS3)
            }
        }
        requireActivity().onBackPressedDispatcher.addCallback(
            <span class="s0">this</span>,  <span class="s2">// LifecycleOwner</span>
            callback
        )
    }

    override <span class="s0">fun </span>onCreateOptionsMenu(menu: Menu, inflater: MenuInflater) {
        inflater.inflate(R.menu.menu_s3, menu)
        <span class="s0">return super</span>.onCreateOptionsMenu(menu, inflater)
    }

    override <span class="s0">fun </span>onOptionsItemSelected(item: MenuItem): Boolean {

        <span class="s0">when </span>(item.itemId) {R.id.item_backS3 -&gt; { navController.popBackStack() } }

        <span class="s0">return super</span>.onOptionsItemSelected(item)
    }

    private <span class="s0">fun </span>arrayDays(days: ArrayList&lt;String&gt;): ArrayList&lt;DataEntry&gt; {

        AndroidThreeTen.init(activity)
        <span class="s0">val </span>today = LocalDate.now()
        <span class="s0">var </span>xAxis = mutableListOf&lt;String&gt;()
        <span class="s0">val </span>format1 = DateTimeFormatter.ofPattern(<span class="s4">&quot;dd/MM/yyyy&quot;</span>)
        <span class="s0">val </span>firstDay = LocalDate.parse(days[<span class="s3">0</span>], format1)
        <span class="s0">val </span>dataDays = ArrayList&lt;DataEntry&gt;()
        <span class="s0">var </span>daysPassed = abs(today.until(firstDay, ChronoUnit.DAYS))


        <span class="s0">if </span>(daysPassed &gt; <span class="s3">100</span>) { daysPassed = <span class="s3">100 </span>}
        <span class="s0">if </span>(daysPassed.toInt() == <span class="s3">0</span>) {

            xAxis.add(format1.format(today))
            dataDays.add(ValueDataEntry(xAxis[<span class="s3">0</span>], days.count { it == xAxis[<span class="s3">0</span>] }))

        } <span class="s0">else </span>{


            <span class="s0">for </span>(i <span class="s0">in </span><span class="s3">0</span>..daysPassed) { xAxis.add(format1.format(today.plusDays(-i))) }

            xAxis = xAxis.asReversed()
            <span class="s0">val </span>last = xAxis.size-<span class="s3">1</span>
            <span class="s0">for </span>(i <span class="s0">in </span><span class="s3">0</span>..last) { dataDays.add(ValueDataEntry(xAxis[i], days.count {it == xAxis[i]})) }

        }
            <span class="s0">return </span>dataDays
        }
}




</pre>
</body>
</html>